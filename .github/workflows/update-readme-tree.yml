name: Auto-update README (tools + links + tree)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y tree

      - name: Generate README sections
        env:
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          # Repo slug: zzpy20/personal-scripts
          OWNER="${REPO%/*}"
          NAME="${REPO#*/}"
          PAGES_BASE="https://${OWNER}.github.io/${NAME}/"

          # 1) Tools list from *.html (excluding index.html)
          # Keep stable ordering
          mapfile -t HTMLS < <(find . -maxdepth 1 -type f -name "*.html" -printf "%f\n" | sort)

          TOOLS_MD=""
          for f in "${HTMLS[@]}"; do
            if [[ "$f" == "index.html" ]]; then
              continue
            fi
            # URL encode spaces only (good enough for your current filenames)
            url="${f// /%20}"
            title="${f%.html}"
            TOOLS_MD+="- **${title}** ‚Äî [Open](${PAGES_BASE}${url})\n"
          done

          if [[ -z "$TOOLS_MD" ]]; then
            TOOLS_MD="(No tools found)\n"
          fi

          # 2) File tree (ignore noise)
          TREE="$(tree -a -L 3 -I '.git|.github|node_modules|README.md|LICENSE|.DS_Store' | sed 's/\r$//')"

          # 3) Replace blocks in README
          replace_block () {
            local start="$1"
            local end="$2"
            local content="$3"

            # Append markers if missing
            if ! grep -qF "$start" README.md || ! grep -qF "$end" README.md; then
              printf "\n%s\n```text\n(auto-generated)\n```\n%s\n" "$start" "$end" >> README.md
            fi

            perl -0777 -i -pe "s/\\Q$start\\E.*?\\Q$end\\E/$start\n$content\n$end/s" README.md
          }

          replace_block "<!-- TOOLS_START -->" "<!-- TOOLS_END -->" "### üåê Live Tools (GitHub Pages)\n\n${TOOLS_MD}"
          replace_block "<!-- FILE_TREE_START -->" "<!-- FILE_TREE_END -->" "```text\n${TREE}\n```"

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto-update README (tools + tree)"
          file_pattern: README.md
