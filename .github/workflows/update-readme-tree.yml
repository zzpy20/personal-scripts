name: Auto-update README (homepage + tools + tree)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install tree
        run: sudo apt-get update && sudo apt-get install -y tree

      - name: Generate content
        env:
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          OWNER="${REPO%/*}"
          NAME="${REPO#*/}"
          PAGES_BASE="https://${OWNER}.github.io/${NAME}/"

          # Homepage (index.html) link
          HOMEPAGE_LINE="ðŸ‘‰ **Homepage:** [Open ${PAGES_BASE}]( ${PAGES_BASE} )"
          # Note: weâ€™ll format it cleanly in the README block below (without extra spaces)
          echo "$PAGES_BASE" > PAGES_BASE.txt

          # Tools list from *.html (excluding index.html)
          TOOLS_MD_FILE="TOOLS_SECTION.md"
          : > "$TOOLS_MD_FILE"

          while IFS= read -r f; do
            [[ -z "$f" ]] && continue
            [[ "$f" == "index.html" ]] && continue

            title="${f%.html}"
            url="${f// /%20}"   # encode spaces only (matches your current filenames)

            printf -- "- **%s** â€” [Open](%s%s)\n" "$title" "$PAGES_BASE" "$url" >> "$TOOLS_MD_FILE"
          done < <(find . -maxdepth 1 -type f -name "*.html" -printf "%f\n" | sort)

          if [[ ! -s "$TOOLS_MD_FILE" ]]; then
            echo "(No HTML tools found)" > "$TOOLS_MD_FILE"
          fi

          # File tree (hide noise)
          TREE_FILE="TREE_SECTION.txt"
          tree -a -L 2 -I '.git|.github|node_modules|.DS_Store|README.md|LICENSE' > "$TREE_FILE"

      - name: Update README.md (rebuild blocks)
        run: |
          set -euo pipefail

          PAGES_BASE="$(cat PAGES_BASE.txt)"
          TOOLS_CONTENT="$(cat TOOLS_SECTION.md)"
          TREE_CONTENT="$(cat TREE_SECTION.txt)"

          HOME_START="<!-- HOME_START -->"
          HOME_END="<!-- HOME_END -->"
          TOOLS_START="<!-- TOOLS_START -->"
          TOOLS_END="<!-- TOOLS_END -->"
          TREE_START="<!-- FILE_TREE_START -->"
          TREE_END="<!-- FILE_TREE_END -->"

          # Ensure markers exist; append defaults if missing
          if ! grep -qF "$HOME_START" README.md || ! grep -qF "$HOME_END" README.md; then
            # Put homepage block at end if missing; user template should place it at top
            cat >> README.md <<'EOF'

          <!-- HOME_START -->
          (auto-generated)
          <!-- HOME_END -->
          EOF
          fi

          if ! grep -qF "$TOOLS_START" README.md || ! grep -qF "$TOOLS_END" README.md; then
            cat >> README.md <<'EOF'

          ## ðŸŒ Live Tools (GitHub Pages)

          <!-- TOOLS_START -->
          (auto-generated)
          <!-- TOOLS_END -->
          EOF
          fi

          if ! grep -qF "$TREE_START" README.md || ! grep -qF "$TREE_END" README.md; then
            cat >> README.md <<'EOF'

          ## ðŸ“ File Structure

          <!-- FILE_TREE_START -->
          ```text
          (auto-generated)
          ```
          <!-- FILE_TREE_END -->
          EOF
          fi

          HOME_CONTENT="ðŸ‘‰ **Homepage:** [Open ${PAGES_BASE}]( ${PAGES_BASE} )"
          # Clean up the markdown link (remove spaces inside parentheses)
          HOME_CONTENT="$(echo "$HOME_CONTENT" | sed "s/( ${PAGES_BASE} )/(${PAGES_BASE})/")"

          # Rebuild README deterministically
          awk -v hs="$HOME_START" -v he="$HOME_END" \
              -v ts="$TOOLS_START" -v te="$TOOLS_END" \
              -v fs="$TREE_START"  -v fe="$TREE_END" \
              -v home="$HOME_CONTENT" -v tools="$TOOLS_CONTENT" -v tree="$TREE_CONTENT" '
            BEGIN {in_home=0; in_tools=0; in_tree=0}

            $0==hs { print; print home;  in_home=1;  next }
            $0==he { in_home=0;  print; next }

            $0==ts { print; print tools; in_tools=1; next }
            $0==te { in_tools=0; print; next }

            $0==fs { print; print "```text"; print tree; print "```"; in_tree=1; next }
            $0==fe { in_tree=0; print; next }

            (in_home==0 && in_tools==0 && in_tree==0) { print }
          ' README.md > README.tmp && mv README.tmp README.md

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto-update README (homepage + tools + tree)"
          file_pattern: README.md
